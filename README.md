# 海底二万マイル 整理券予約システム (Flask版)

## 概要
「海底二万マイル」という体験型施設の整理券予約システムのPython Flask版です。
時間帯別の予約管理、QRコード付き整理券発行、管理者認証、チェックイン機能を提供します。
**複数のユーザーが同時に独立して予約を行うことができます。**

## 機能
- **ウェルカム画面**: 初回訪問者向けの案内画面
- **予約システム**: 時間帯選択、人数選択、QRコード付き整理券発行
- **整理券確認**: 予約済み整理券の確認とQRコード表示
- **セッション管理**: 複数ユーザーの同時利用に対応
- **管理者認証**: ログイン/ログアウト機能付き管理画面
- **管理画面**: 統計表示、時間帯別状況確認、定員数管理
- **QRチェックイン機能**: QRコードスキャンによるチェックイン処理
- **管理者チェックイン**: 管理者による手動チェックイン
- **パブリックチェックイン完了**: 来場者向けチェックイン完了画面
- **キャンセル機能**: 予約のキャンセル処理
- **データ永続化**: JSONファイルによるデータ管理
- **レスポンシブデザイン**: モバイル端末対応のUI

## セットアップ手順

### 1. 依存関係のインストール
```bash
pip install -r requirements.txt
```

### 2. アプリケーションの起動
```bash
python main.py
```

### 3. アクセス
- **ウェルカム画面**: http://localhost:8000/
- **予約画面**: http://localhost:8000/reserve
- **整理券確認**: http://localhost:8000/my-ticket
- **管理者ログイン**: http://localhost:8000/admin/login
- **管理画面**: http://localhost:8000/admin（要認証）
- **QRチェックイン**: http://localhost:8000/admin/qr-checkin（要認証）
- **管理者チェックイン**: http://localhost:8000/admin/checkin（要認証）

## 管理者認証
- **ユーザー名**: admin
- **パスワード**: password123
- **認証有効期限**: 24時間（クッキーベース）

## ファイル構成
```
├── main.py                         # メインアプリケーション
├── requirements.txt                # 依存関係
├── timeslots.json                 # 時間帯データ
├── reservations.json              # 予約データ
├── README.md                      # このファイル
├── templates/                     # HTMLテンプレート
│   ├── base.html                  # ベーステンプレート
│   ├── welcome.html               # ウェルカム画面
│   ├── index.html                 # 予約画面
│   ├── my_ticket.html             # 整理券確認画面
│   ├── completion.html            # 予約完了画面
│   ├── admin_login.html           # 管理者ログイン画面
│   ├── admin.html                 # 管理画面
│   ├── admin_checkin.html         # 管理者チェックイン画面
│   ├── qr_checkin.html            # QRチェックイン画面
│   ├── checkin_success.html       # チェックイン成功画面
│   └── public_checkin_complete.html # パブリックチェックイン完了画面
└── static/                        # 静的ファイル
    ├── css/                       # スタイルシート
    │   ├── base.css              # 共通スタイル
    │   └── style.css             # ページ固有スタイル
    ├── img/                       # 画像ファイル
    │   └── image.png             # システム用画像
    └── js/                        # JavaScript（空）
```

## 主要なルート
### 一般ユーザー向け
- `GET /` - ウェルカム画面
- `GET /reserve` - 予約画面
- `GET /my-ticket` - 整理券確認画面
- `GET /completion` - 予約完了画面
- `GET /checkin-complete` - パブリックチェックイン完了画面

### 管理者向け（要認証）
- `GET /admin/login` - 管理者ログイン画面
- `GET /admin/logout` - 管理者ログアウト
- `GET /admin` - 管理画面
- `GET /admin/checkin` - 管理者チェックイン画面
- `GET /admin/qr-checkin` - QRチェックイン画面
- `GET /admin/checkin-success` - チェックイン成功画面

## API エンドポイント
### 一般API
- `GET /api/timeslots/<guests>` - 指定人数の利用可能時間帯取得
- `POST /api/reserve` - 予約作成
- `POST /api/cancel` - 予約キャンセル

### 管理者API（要認証）
- `POST /api/checkin` - 手動チェックイン
- `POST /api/qr-checkin` - QRコードチェックイン
- `POST /api/update_capacity` - 定員数更新

## データ管理
- **timeslots.json**: 時間帯の定員と空き状況
- **reservations.json**: 予約履歴（active/cancelled/checked）とセッション情報

## セッション管理
- 各ユーザーに固有のセッションIDを割り当て（UUID）
- 複数のユーザーが同時に独立して予約可能
- セッション別の予約状態管理
- QRコードにセッションIDを含め、重複を防止
- 管理画面では全セッションの集約データを表示
- セッション有効期限: 31日間

## 認証システム
- セッションベース認証とクッキーベース認証の併用
- 24時間有効な認証クッキー
- 管理者機能へのアクセス制御
- 自動ログアウト機能

## QRコード機能
- 予約時にQRコード生成
- QRコードスキャンによる自動チェックイン
- パブリックチェックイン完了画面への誘導
- エラーハンドリング付きQRコード読み取り

## CSS構成
- **base.css**: 共通スタイル（レイアウト、基本コンポーネント、レスポンシブ対応）
- **style.css**: 各ページ固有のスタイル（全画面対応）

## 技術仕様
- **フレームワーク**: Flask 2.3.3
- **テンプレートエンジン**: Jinja2
- **QRコード生成**: qrcode[pil] 7.4.2
- **画像処理**: Pillow 10.4.0
- **セッション管理**: Flask Sessions + UUID
- **認証**: セッション + クッキーベース
- **データ保存**: JSON形式
- **ポート**: 8000番（デフォルト）

## 注意事項
- 各セッション（ユーザー）につき1つのアクティブな予約を保持
- 複数のユーザーが同時にシステムを利用可能
- QRコードは予約情報とセッションIDに基づいて生成
- 管理画面は5秒間隔で自動更新
- 管理者認証は24時間有効
- データはJSONファイルに永続化されます
- CSSファイルの変更は自動反映されます（開発モード）

## 開発者向け
- Flask開発モードで実行（`debug=True`）
- 静的ファイルは`static/`ディレクトリに配置
- 画像ファイルは`static/img/`に配置
- CSSは2ファイル構成で保守性を向上
- 全画面でレスポンシブデザイン対応済み
- セッション管理により複数ユーザーの同時利用に対応
- セッション別予約管理でデータ整合性を確保
- 管理者認証システムでセキュリティを強化
- QRコードによる効率的なチェックイン処理

## セキュリティ考慮事項
- 本番環境では`app.secret_key`を変更してください
- HTTPS使用時は`secure=True`にクッキー設定を変更してください
- 管理者パスワードは本番環境で変更してください 