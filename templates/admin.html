{% extends "base.html" %}

{% block title %}ç®¡ç†ç”»é¢ - æµ·åº•äºŒä¸‡ãƒã‚¤ãƒ«{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><span class="emoji">âš™ï¸</span>ç®¡ç†ç”»é¢</h1>
    <div class="nav-links">
        <a href="{{ url_for('index') }}" class="nav-link">
            <span class="emoji">ğŸ </span>ãƒ›ãƒ¼ãƒ 
        </a>
        <a href="{{ url_for('reserve') }}" class="nav-link">
            <span class="emoji">ğŸ«</span>äºˆç´„ç”»é¢
        </a>
        <a href="/admin/checkin" class="nav-link">
            <span class="emoji">âœ…</span>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
        </a>
    </div>
</div>

<!-- çµ±è¨ˆæ¦‚è¦ -->
<div class="stats-overview">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_reservations }}</div>
        <div class="stat-label"><span class="emoji">ğŸ“</span>ç·äºˆç´„è€…æ•°</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_checkins }}</div>
        <div class="stat-label"><span class="emoji">âœ…</span>ç·æ¥å ´è€…æ•°</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.checkin_rate }}%</div>
        <div class="stat-label"><span class="emoji">ğŸ“ˆ</span>æ¥å ´ç‡</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_capacity }}</div>
        <div class="stat-label"><span class="emoji">ğŸ </span>ç·å®šå“¡æ•°</div>
    </div>
</div>

<!-- æ™‚é–“å¸¯ç®¡ç† -->
<div class="time-slots-section">
    <h2 class="section-title">
        <span class="emoji">â°</span>æ™‚é–“å¸¯åˆ¥çŠ¶æ³
    </h2>
    
    {% for slot in timeslots %}
    <div class="time-slot-admin">
        <div class="time-info">{{ slot.time }}</div>
        
        <div class="slot-stats">
            <div>äºˆç´„: {{ slot.reserved }}/{{ slot.total }}å</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill progress-reserved" 
                     style="width: {{ (slot.reserved / slot.total * 100) if slot.total > 0 else 0 }}%"></div>
            </div>
        </div>
        
        <div class="slot-stats">
            <div>æ¥å ´: {{ slot.checked }}å</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill progress-checked" 
                     style="width: {{ (slot.checked / slot.reserved * 100) if slot.reserved > 0 else 0 }}%"></div>
            </div>
        </div>
        
        <div class="capacity-control">
            <button class="capacity-btn" onclick="changeCapacity({{ loop.index0 }}, -1)">âˆ’</button>
            <input type="number" class="capacity-input" 
                   value="{{ slot.total }}" 
                   min="0" max="50"
                   onchange="updateCapacity({{ loop.index0 }}, this.value)">
            <button class="capacity-btn" onclick="changeCapacity({{ loop.index0 }}, 1)">+</button>
        </div>
        
        <button class="checkin-btn" 
                onclick="goToCheckin('{{ slot.time }}', {{ slot.reserved }})"
                {{ 'disabled' if slot.reserved == 0 else '' }}>
            ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
        </button>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function changeCapacity(index, change) {
    const input = document.querySelectorAll('.capacity-input')[index];
    const newValue = Math.max(0, Math.min(50, parseInt(input.value) + change));
    input.value = newValue;
    updateCapacity(index, newValue);
}

async function updateCapacity(index, total) {
    try {
        const response = await fetch('/api/update_capacity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                index: index,
                total: parseInt(total)
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°çŠ¶æ…‹ã‚’è¡¨ç¤º
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            alert('å®šå“¡æ•°ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('å®šå“¡æ•°ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

function goToCheckin(time, guests) {
    if (guests === 0) {
        alert('ã“ã®æ™‚é–“å¸¯ã«ã¯äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    const url = `/admin/checkin?time=${encodeURIComponent(time)}&guests=${guests}`;
    window.location.href = url;
}

// 10ç§’ã”ã¨ã«çµ±è¨ˆã‚’æ›´æ–°
setInterval(() => {
    location.reload();
}, 10000);
</script>
{% endblock %} 