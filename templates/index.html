{% extends "base.html" %}

{% block title %}äºˆç´„ã‚·ã‚¹ãƒ†ãƒ  - æµ·åº•äºŒä¸‡ãƒã‚¤ãƒ«{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block content %}
<h1><span class="emoji">ğŸŒŠ</span>æµ·åº•äºŒä¸‡ãƒã‚¤ãƒ« æ•´ç†åˆ¸äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </h1>

{% if active_reservation %}
<!-- æ—¢å­˜ã®äºˆç´„ãŒã‚ã‚‹å ´åˆã®è¡¨ç¤º -->
<div class="ticket">
    <h2><span class="emoji">ğŸ«</span>ã‚ãªãŸã®æ•´ç†åˆ¸</h2>
    <div class="qr-code">
        <img src="{{ active_reservation.qr_code_image }}" alt="QRã‚³ãƒ¼ãƒ‰">
    </div>
    <div class="ticket-info">
        <p><strong>äºˆç´„æ™‚é–“:</strong> {{ active_reservation.time }}</p>
        <p><strong>äººæ•°:</strong> {{ active_reservation.guests }}å</p>
        <p><strong>äºˆç´„æ—¥:</strong> {{ active_reservation.date }}</p>
    </div>
    <p>ã“ã®ç”»é¢ã‚’ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠè¦‹ã›ãã ã•ã„</p>
    <div class="mt-20">
        <button onclick="cancelReservation()" class="btn btn-danger">
            <span class="emoji">âŒ</span>äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
    </div>
</div>

{% else %}
<!-- æ–°è¦äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="progress-bar">
    <div class="progress-step active" id="progress-1">1</div>
    <div class="progress-step" id="progress-2">2</div>
    <div class="progress-step" id="progress-3">3</div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—1: æ™‚é–“é¸æŠ -->
<div id="step1" class="step active">
    <h2><span class="emoji">â°</span>æ™‚é–“å¸¯ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
    <div class="time-slots">
        {% for slot in timeslots %}
        <div class="time-slot {{ 'disabled' if slot.available <= 0 else '' }}" 
             onclick="selectTime('{{ slot.time }}', {{ slot.available }})"
             data-time="{{ slot.time }}" data-available="{{ slot.available }}">
            <div class="time-text">{{ slot.time }}</div>
            <div class="availability">
                {% if slot.available > 0 %}
                    ç©ºã: {{ slot.available }}å
                {% else %}
                    æº€å¸­
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="navigation">
        <div></div>
        <button onclick="goToStep2()" class="btn" id="next-step1" disabled>
            æ¬¡ã¸ <span class="emoji">â–¶ï¸</span>
        </button>
    </div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—2: äººæ•°é¸æŠ -->
<div id="step2" class="step">
    <h2><span class="emoji">ğŸ‘¥</span>äººæ•°ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
    <div class="guests-grid" id="guests-grid">
        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>
    <div class="navigation">
        <button onclick="goToStep1()" class="btn">
            <span class="emoji">â—€ï¸</span> æˆ»ã‚‹
        </button>
        <button onclick="goToStep3()" class="btn" id="next-step2" disabled>
            æ¬¡ã¸ <span class="emoji">â–¶ï¸</span>
        </button>
    </div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—3: ç¢ºèªãƒ»äºˆç´„ -->
<div id="step3" class="step">
    <h2><span class="emoji">âœ…</span>äºˆç´„å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</h2>
    <div class="ticket-info">
        <p><strong>äºˆç´„æ™‚é–“:</strong> <span id="confirm-time"></span></p>
        <p><strong>äººæ•°:</strong> <span id="confirm-guests"></span>å</p>
        <p><strong>äºˆç´„æ—¥:</strong> <span id="confirm-date"></span></p>
    </div>
    <div class="navigation">
        <button onclick="goToStep2()" class="btn">
            <span class="emoji">â—€ï¸</span> æˆ»ã‚‹
        </button>
        <button onclick="confirmReservation()" class="btn btn-success">
            <span class="emoji">ğŸ«</span> äºˆç´„ã‚’ç¢ºå®šã™ã‚‹
        </button>
    </div>
</div>

<!-- äºˆç´„å®Œäº† -->
<div id="step4" class="step">
    <h2><span class="emoji">ğŸ‰</span>äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h2>
    <div class="ticket">
        <h3><span class="emoji">ğŸ«</span>ã‚ãªãŸã®æ•´ç†åˆ¸</h3>
        <div class="qr-code" id="final-qr-code">
            <!-- QRã‚³ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        <div class="ticket-info">
            <p><strong>äºˆç´„æ™‚é–“:</strong> <span id="final-time"></span></p>
            <p><strong>äººæ•°:</strong> <span id="final-guests"></span>å</p>
            <p><strong>äºˆç´„æ—¥:</strong> <span id="final-date"></span></p>
        </div>
        <p>ã“ã®ç”»é¢ã‚’ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠè¦‹ã›ãã ã•ã„</p>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
let selectedTime = null;
let selectedGuests = null;
let maxGuests = 0;

function selectTime(time, available) {
    if (available <= 0) return;
    
    // æ—¢å­˜ã®é¸æŠã‚’è§£é™¤
    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('selected');
    });
    
    // æ–°ã—ã„é¸æŠã‚’è¨­å®š
    const slot = document.querySelector(`[data-time="${time}"]`);
    slot.classList.add('selected');
    
    selectedTime = time;
    maxGuests = available;
    
    document.getElementById('next-step1').disabled = false;
}

function selectGuests(guests) {
    document.querySelectorAll('.guest-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    const btn = document.querySelector(`[data-guests="${guests}"]`);
    btn.classList.add('selected');
    
    selectedGuests = guests;
    document.getElementById('next-step2').disabled = false;
}

function goToStep1() {
    document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
    document.getElementById('step1').classList.add('active');
    
    document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.remove('active', 'completed');
    });
    document.getElementById('progress-1').classList.add('active');
}

function goToStep2() {
    if (!selectedTime) return;
    
    document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
    document.getElementById('step2').classList.add('active');
    
    document.getElementById('progress-1').classList.add('completed');
    document.getElementById('progress-1').classList.remove('active');
    document.getElementById('progress-2').classList.add('active');
    
    // äººæ•°é¸æŠãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
    const guestsGrid = document.getElementById('guests-grid');
    guestsGrid.innerHTML = '';
    
    for (let i = 1; i <= Math.min(maxGuests, 10); i++) {
        const btn = document.createElement('div');
        btn.className = 'guest-btn';
        btn.setAttribute('data-guests', i);
        btn.textContent = `${i}å`;
        btn.onclick = () => selectGuests(i);
        guestsGrid.appendChild(btn);
    }
}

function goToStep3() {
    if (!selectedGuests) return;
    
    document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
    document.getElementById('step3').classList.add('active');
    
    document.getElementById('progress-2').classList.add('completed');
    document.getElementById('progress-2').classList.remove('active');
    document.getElementById('progress-3').classList.add('active');
    
    // ç¢ºèªå†…å®¹ã‚’è¡¨ç¤º
    document.getElementById('confirm-time').textContent = selectedTime;
    document.getElementById('confirm-guests').textContent = selectedGuests;
    document.getElementById('confirm-date').textContent = new Date().toLocaleDateString('ja-JP');
}

async function confirmReservation() {
    try {
        const response = await fetch('/api/reserve', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                time: selectedTime,
                guests: selectedGuests
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // äºˆç´„å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById('step4').classList.add('active');
            
            document.getElementById('progress-3').classList.add('completed');
            
            // äºˆç´„å†…å®¹ã‚’è¡¨ç¤º
            document.getElementById('final-time').textContent = result.reservation.time;
            document.getElementById('final-guests').textContent = result.reservation.guests;
            document.getElementById('final-date').textContent = result.reservation.date;
            
            // QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            const qrCodeDiv = document.getElementById('final-qr-code');
            qrCodeDiv.innerHTML = `<img src="${result.reservation.qr_code_image}" alt="QRã‚³ãƒ¼ãƒ‰">`;
            
            // æ•°ç§’å¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            alert('äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('äºˆç´„ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

async function cancelReservation() {
    if (!confirm('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    try {
        const response = await fetch('/api/cancel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
            location.reload();
        } else {
            alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}
</script>
{% endblock %} 